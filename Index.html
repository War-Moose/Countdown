<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Task Tracker v1.2 (Refactored)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Confetti library -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* ——— CORE STYLES ——— */
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f0f0f0; color: #000; }
    body.dark { background-color: #121212; color: #e0e0e0; }
    .counter { font-size: 1.2em; margin: 5px; }
    button { font-size: 1.2em; padding: 10px 20px; margin: 10px; cursor: pointer; }

    /* ——— CALENDAR ——— */
    .calendar { display: grid; grid-template-columns: repeat(7, 40px); gap: 4px; justify-content: center; margin-top: 20px; }
    .day { width: 40px; height: 40px; border: 1px solid #999; display: flex; align-items: center; justify-content: center; font-size: 0.8em; }
    .white { background-color: white; color: black; }
    .red   { background-color: red;   color: white; }
    .blue  { background-color: blue;  color: white; }
    .black { background-color: black; color: white; }

    /* ——— TITLE & BADGES ——— */
    #title-container { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .title-badge { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; }

    /* ——— SETTINGS MENU ——— */
    #menuOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 999; }
    #settingsMenu { display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: rgba(0, 0, 0, 0.8); color: white; padding: 30px; border-radius: 10px; z-index: 1000; text-align: center; width: 80%; max-width: 300px; }
    #settingsMenu button, #settingsMenu select { display: block; width: 80%; margin: 10px auto; font-size: 1em; padding: 8px; }

    /* ——— BADGE MODAL ——— */
    #badgeModal { display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 20px; border-radius: 10px; z-index: 2000; max-width: 600px; text-align: center; }
    #badgeGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; justify-items: center; margin-top: 20px; }
    #badgePopup { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 15px 30px; border-radius: 8px; z-index: 3000; box-shadow: 0 0 10px #000; font-weight: bold; }

    /* ——— STREAK GLOW ——— */
    @keyframes streakPop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
    .streak-boost { animation: streakPop 0.8s ease-in-out; color: orange; text-shadow: 0 0 8px orange, 0 0 12px black; }

    /* ——— POMODORO ——— */
    #pomodoroOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 3500; }
    .pom-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 20px; border-radius: 8px; z-index: 4000; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-align: center; width: 200px; }
    body.dark .pom-modal { background: #333; color: #e0e0e0; }
    #pomProgressContainer { position: relative; width: 140px; height: 140px; margin: 20px auto; border-radius: 50%; background: conic-gradient(black 0%, black 100%); }
    #pomTimerDisplay { position: absolute; width: 100%; height: 100%; top: 0; left: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5em; }

    /* ——— ANALYTICS ——— */
    #analyticsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 3500; }
    .analytics-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; padding: 20px; border-radius: 8px; z-index: 4000; box-shadow: 0 0 10px rgba(0,0,0,0.5); width: 90%; max-width: 600px; text-align: center; overflow-y: auto; max-height: 90vh; }
    body.dark .analytics-modal { background: #333; color: #e0e0e0; }
    .chart-nav { display: flex; justify-content: center; align-items: center; margin-bottom: 8px; }
    .chart-nav button { margin: 0 10px; }
    .chart-label { font-weight:bold; margin: 0 8px; }
    .chart-container { width:100%; margin:20px 0; }
  </style>
</head>
<body>
  <!-- TITLE + DYNAMIC BADGES -->
  <div id="title-container">
    <div id="badgeLeft" class="title-badge"></div>
    <h1 style="margin:0 10px;">Daily Task Tracker v1.2</h1>
    <div id="badgeRight" class="title-badge"></div>
  </div>

  <!-- COUNTERS -->
  <p class="counter">Date: <span id="currentDate"></span></p>
  <p class="counter">Daily Tasks Left: <span id="tasksLeft"></span></p>
  <p class="counter">Daily Tasks Completed: <span id="tasksDone"></span></p>
  <p class="counter">Total Tasks Completed: <span id="totalTasksDone"></span></p>
  <p class="counter">Current Streak: <span id="streak"></span> days</p>
  <p class="counter">Longest Streak: <span id="longestStreak"></span> days</p>

  <!-- MAIN CONTROLS -->
  <button id="btn-complete">Complete Task</button>
  <button id="btn-reset-day">Reset Day</button>
  <button data-action="changeDay" data-offset="-1">-1 Day</button>
  <button data-action="changeDay" data-offset="1">+1 Day</button>
  <button id="btn-export">Save Backup</button>
  <input type="file" id="importInput" accept=".json" style="display:none"/>
  <button id="btn-import">Import Backup</button>
  <button data-toggle="menu">Menu</button>
  <button data-toggle="pomodoro">Pomodoro</button>
  <button data-toggle="analytics">Analytics</button>

  <!-- CALENDAR -->
  <div class="calendar" id="calendar"></div>

  <!-- SETTINGS MENU -->
  <div id="menuOverlay" onclick="toggleModal('settingsMenu','menuOverlay')"></div>
  <div id="settingsMenu">
    <h2>Settings Menu</h2>
    <select id="selectLeftBadge"></select>
    <select id="selectRightBadge"></select>
    <button onclick="toggleModal('badgeModal','menuOverlay')">Badges</button>
    <button id="btn-reset-badges">Reset Badges</button>
    <button id="btn-reset-total">Reset Total Tasks</button>
    <button data-action="changeDay" data-offset="-1">-1 Day</button>
    <button data-action="changeDay" data-offset="1">+1 Day</button>
    <button id="btn-toggle-dark">Toggle Dark Mode</button>
    <button onclick="toggleModal('settingsMenu','menuOverlay')">Close</button>
  </div>

  <!-- BADGE MODAL -->
  <div id="badgeModal">
    <h2>Achievements</h2>
    <div id="badgeGrid"></div>
    <button onclick="toggleModal('badgeModal','menuOverlay')">Close</button>
  </div>
  <div id="badgePopup"></div>

  <!-- POMODORO MODAL -->
  <div id="pomodoroOverlay" onclick="toggleModal('pomodoroModal','pomodoroOverlay',resetPom**)"></div>
  <div id="pomodoroModal" class="pom-modal">
    <h2>Pomodoro Timer</h2>
    <div id="pomProgressContainer">
      <div id="pomTimerDisplay">25:00</div>
    </div>
    <button id="pomStartBtn">Start Pomodoro</button>
    <button onclick="toggleModal('pomodoroModal','pomodoroOverlay',resetPom)">Close</button>
  </div>

  <!-- ANALYTICS MODAL -->
  <div id="analyticsOverlay" onclick="toggleModal('analyticsModal','analyticsOverlay')"></div>
  <div id="analyticsModal" class="analytics-modal">
    <h2>Weekly • Monthly • Year Analytics</h2>
    <div class="chart-nav">
      <button id="week-prev">←</button>
      <span id="weeklyLabel" class="chart-label"></span>
      <button id="week-next">→</button>
    </div>
    <div class="chart-container"><canvas id="weeklyChart"></canvas></div>
    <div class="chart-nav">
      <button id="month-prev">←</button>
      <span id="monthlyLabel" class="chart-label"></span>
      <button id="month-next">→</button>
    </div>
    <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
    <div class="chart-nav">
      <button id="year-prev">←</button>
      <span id="yearLabel" class="chart-label"></span>
      <button id="year-next">→</button>
    </div>
    <div class="chart-container"><canvas id="yearChart"></canvas></div>
    <button onclick="toggleModal('analyticsModal','analyticsOverlay')">Close</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ——— HELPERS ———
      const parseDate = s => { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); };
      const formatDate = dt => dt.toISOString().slice(0,10);
      const addDays = (d,n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
      const weekdays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      const store = { get: (k,d)=>{ const v=localStorage.getItem(k); return v?JSON.parse(v):d; }, set: (k,v)=>localStorage.setItem(k,JSON.stringify(v)) };

      // ——— STATE ———
      const defaultTasks = 3;
      let today = formatDate(new Date());
      const state = {
        tasksLeft:      store.get('tasksLeft', defaultTasks),
        tasksDone:      store.get('tasksDone', 0),
        totalTasksDone: store.get('totalTasksDone', 0),
        streak:         store.get('streak', 0),
        longestStreak:  store.get('longestStreak', 0),
        taskLog:        store.get('taskLog', {}),
        badges:         store.get('badges', [
          { id:'badge_first',   name:'First Task',   desc:'Complete 1 task',        unlocked:false },
          { id:'badge_five',    name:'Five Tasks',   desc:'Complete 5 total tasks', unlocked:false },
          { id:'badge_streak3', name:'3-Day Streak', desc:'Achieve a 3-day streak', unlocked:false }
        ]),
        savedDate:      store.get('taskDate', '')
      };

      // Daily reset on new day
      if (state.savedDate !== today) {
        state.tasksLeft = defaultTasks;
        state.tasksDone = 0;
        state.savedDate = today;
        localStorage.removeItem('streakLastCounted');
        store.set('tasksLeft', state.tasksLeft);
        store.set('tasksDone', state.tasksDone);
        store.set('taskDate', today);
      }

      // Persist selected keys
      const save = keys => keys.forEach(k => store.set(k, state[k]));

      // ——— STREAK LOGIC ———
      function calcLongest() {
        const dates = Object.keys(state.taskLog).filter(d => state.taskLog[d] >= defaultTasks).sort();
        let max=0,count=0,prev;
        dates.forEach(d => {
          count = (prev && (parseDate(d)-parseDate(prev))/86400000===1)? count+1 : 1;
          max = Math.max(max, count);
          prev = d;
        });
        return max;
      }
      function updateStreak() {
        const yesterday = formatDate(addDays(parseDate(today), -1));
        if (!(state.taskLog[yesterday] >= defaultTasks)) state.streak = 0;
        if (state.taskLog[today] === defaultTasks && localStorage.getItem('streakLastCounted') !== today) {
          state.streak++;
          localStorage.setItem('streakLastCounted', today);
        }
        state.longestStreak = calcLongest();
        save(['streak','longestStreak']);
      }

      // ——— BADGES ———
      function showPopup(msg) {
        const p = document.getElementById('badgePopup');
        p.textContent = msg;
        p.style.display = 'block';
        setTimeout(() => p.style.display = 'none', 3000);
      }
      function checkBadges() {
        let updated = false;
        state.badges.forEach(b => {
          if (!b.unlocked && (
            (b.id === 'badge_first'   && state.totalTasksDone >= 1) ||
            (b.id === 'badge_five'    && state.totalTasksDone >= 5) ||
            (b.id === 'badge_streak3' && state.streak >= 3)
          )) {
            b.unlocked = true;
            showPopup(`🏆 Badge Unlocked: ${b.name}!`);
            updated = true;
          }
        });
        if (updated) store.set('badges', state.badges);
      }
      function renderBadgesGrid() {
        const grid = document.getElementById('badgeGrid');
        grid.innerHTML = '';
        state.badges.forEach(b => {
          const div = document.createElement('div');
          div.style.opacity = b.unlocked ? 1 : 0.3;
          div.style.cursor = 'pointer';
          div.innerHTML = `<div style="font-size:2em;">🏅</div><div style="font-size:0.8em;">${b.name}</div>`;
          div.onclick = () => alert(b.unlocked ? b.desc : `Locked: ${b.desc}`);
          grid.appendChild(div);
        });
      }

      // ——— CALENDAR ———
      function drawCalendar() {
        const cal = document.getElementById('calendar'); cal.innerHTML = '';
        const ref = parseDate(today), Y = ref.getFullYear(), M = ref.getMonth();
        const firstDay = new Date(Y, M, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement('div'); empty.className = 'day'; empty.style.visibility = 'hidden';
          cal.appendChild(empty);
        }
        const dim = new Date(Y, M+1, 0).getDate();
        for (let d = 1; d <= dim; d++) {
          const key = formatDate(new Date(Y, M, d));
          const v = state.taskLog[key] || 0;
          const box = document.createElement('div');
          box.className = `day ${['white','red','blue','black'][Math.min(v,3)]}`;
          box.textContent = d;
          cal.appendChild(box);
        }
      }

      // ——— TITLE BADGES ———
      function updateTitleBadges() {
        const map = Object.fromEntries(state.badges.map(b => [b.id, b]));
        ['Left','Right'].forEach(pos => {
          const stored = localStorage.getItem(`titleBadge${pos}`);
          const el = document.getElementById(`badge${pos}`);
          if (map[stored]) { el.textContent = '🏅'; el.title = map[stored].name; }
          else { el.textContent = ''; el.title = ''; }
        });
      }
      function initTitleSelectors() {
        const left = document.getElementById('selectLeftBadge');
        const right = document.getElementById('selectRightBadge');
        state.badges.forEach(b => {
          const optL = document.createElement('option'); optL.value = b.id; optL.textContent = b.name; left.appendChild(optL);
          const optR = optL.cloneNode(true); right.appendChild(optR);
        });
        left.value = localStorage.getItem('titleBadgeLeft') || state.badges[0].id;
        right.value = localStorage.getItem('titleBadgeRight') || state.badges[1].id;
        left.onchange = e => { localStorage.setItem('titleBadgeLeft', e.target.value); updateTitleBadges(); };
        right.onchange = e => { localStorage.setItem('titleBadgeRight', e.target.value); updateTitleBadges(); };
      }

      // ——— MODAL TOGGLE ———
      function toggleModal(modalId, overlayId, cleanup) {
        const m = document.getElementById(modalId), o = document.getElementById(overlayId);
        const show = m.style.display !== 'block';
        m.style.display = show ? 'block' : 'none';
        o.style.display = show ? 'block' : 'none';
        if (!show && typeof cleanup === 'function') cleanup();
      }

      // ——— TASK & CONTROLS ———
      function updateDisplays() {
        document.getElementById('currentDate').textContent = today;
        document.getElementById('tasksLeft').textContent  = state.tasksLeft;
        document.getElementById('tasksDone').textContent  = state.tasksDone;
        document.getElementById('totalTasksDone').textContent = state.totalTasksDone;
        updateStreak();
        document.getElementById('streak').textContent      = state.streak;
        document.getElementById('longestStreak').textContent = state.longestStreak;
        drawCalendar();
        checkBadges();
        renderBadgesGrid();
        updateTitleBadges();
      }

      document.getElementById('btn-complete').addEventListener('click', () => {
        if (state.tasksLeft > 0) state.tasksLeft--;
        state.tasksDone++;
        state.totalTasksDone++;
        state.taskLog[today] = state.tasksDone;
        save(['tasksLeft','tasksDone','totalTasksDone','taskLog']);
        const prevSt = state.streak, prevLg = state.longestStreak;
        updateDisplays();
        ['streak','longestStreak'].forEach(id => {
          const el = document.getElementById(id);
          if (state[id] > (id === 'streak' ? prevSt : prevLg)) {
            el.classList.add('streak-boost');
            setTimeout(() => el.classList.remove('streak-boost'), 800);
          }
        });
        if (state.tasksDone >= defaultTasks) {
          confetti({ particleCount: 100, spread: 60, origin: { y: 0.6 }, colors: ['#000','#FFA500'] });
        }
      });

      document.getElementById('btn-reset-day').addEventListener('click', () => {
        state.tasksDone = 0;
        state.tasksLeft = defaultTasks;
        delete state.taskLog[today];
        save(['tasksDone','tasksLeft','taskLog']);
        updateDisplays();
      });

      document.querySelectorAll('[data-action="changeDay"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const off = Number(btn.dataset.offset);
          const d = addDays(parseDate(today), off);
          today = formatDate(d);
          if (today !== localStorage.getItem('taskDate')) {
            state.tasksDone = 0;
            state.tasksLeft = defaultTasks;
            localStorage.setItem('taskDate', today);
            localStorage.removeItem('streakLastCounted');
          }
          updateDisplays();
        });
      });

      document.getElementById('btn-export').addEventListener('click', () => {
        const data = {
          tasksLeft: state.tasksLeft,
          tasksDone: state.tasksDone,
          totalTasksDone: state.totalTasksDone,
          streak: state.streak,
          longestStreak: state.longestStreak,
          taskLog: state.taskLog,
          badges: state.badges
        };
        const blob = new Blob([JSON.stringify(data,null,2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-${today}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      document.getElementById('btn-import').addEventListener('click', () => document.getElementById('importInput').click());
      document.getElementById('importInput').addEventListener('change', e => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const d = JSON.parse(ev.target.result);
          Object.assign(state, {
            tasksLeft: d.tasksLeft ?? state.tasksLeft,
            tasksDone: d.tasksDone ?? state.tasksDone,
            totalTasksDone: d.totalTasksDone ?? state.totalTasksDone,
            streak: d.streak ?? state.streak,
            longestStreak: d.longestStreak ?? state.longestStreak,
            taskLog: { ...state.taskLog, ...(d.taskLog || {}) },
            badges: d.badges || state.badges
          });
          save(['tasksLeft','tasksDone','totalTasksDone','streak','longestStreak','taskLog','badges']);
          localStorage.setItem('taskDate', today);
          localStorage.removeItem('streakLastCounted');
          updateDisplays();
          alert('✅ Imported successfully');
        };
        reader.readAsText(file);
      });

      // ——— RESET FUNCTIONS ———
      document.getElementById('btn-reset-total').addEventListener('click', () => {
        state.totalTasksDone = 0;
        state.badges.forEach(b => { if (b.id === 'badge_first' || b.id === 'badge_five') b.unlocked = false; });
        save(['totalTasksDone','badges']);
        updateDisplays();
        alert('Total tasks and relevant badges reset.');
      });
      document.getElementById('btn-reset-badges').addEventListener('click', () => {
        state.badges.forEach(b => b.unlocked = false);
        store.set('badges', state.badges);
        renderBadgesGrid();
      });
      document.getElementById('btn-toggle-dark').addEventListener('click', () => {
        const on = document.body.classList.toggle('dark');
        store.set('darkMode', on);
      });

      // ——— POMODORO ———
      let pomInterval, pomPhase = 'work', pomTime = 25*60, pomRunning = false;
      function updatePomDisplay() {
        const m = String(Math.floor(pomTime/60)).padStart(2,'0');
        const s = String(pomTime%60).padStart(2,'0');
        document.getElementById('pomTimerDisplay').textContent = `${m}:${s}`;
      }
      function updatePomProgress() {
        const total = pomPhase==='work'?25*60:5*60;
        const pct = ((total - pomTime)/total)*100;
        document.getElementById('pomProgressContainer').style.background = `conic-gradient(orange ${pct}%, black ${pct}% 100%)`;
      }
      function playTone(duration=0.2) {
        const osc = new (window.AudioContext||window.webkitAudioContext)().createOscillator();
        osc.type='sine'; osc.frequency.value=440; osc.connect(osc.context.destination); osc.start(); osc.stop(osc.context.currentTime+duration);
      }
      function tickPom() {
        pomTime--;
        updatePomDisplay(); updatePomProgress();
        if (pomTime<=0) {
          clearInterval(pomInterval);
          if (pomPhase==='work') { playTone(0.5); startBreak(); } else { playTone(0.5); pomRunning=false; document.getElementById('pomStartBtn').textContent='Start Pomodoro'; }
        }
      }
      function startWork() { pomPhase='work'; pomTime=25*60; updatePomDisplay(); updatePomProgress(); playTone(0.2); pomInterval=setInterval(tickPom,1000); }
      function startBreak() { pomPhase='break'; pomTime=5*60; updatePomDisplay(); updatePomProgress(); playTone(0.2); pomInterval=setInterval(tickPom,1000); }
      function resetPom() { if (pomRunning) clearInterval(pomInterval); pomRunning=false; pomPhase='work'; pomTime=25*60; updatePomDisplay(); updatePomProgress(); document.getElementById('pomStartBtn').textContent='Start Pomodoro'; }
      document.querySelector('[data-toggle="pomodoro"]').addEventListener('click', () => toggleModal('pomodoroModal','pomodoroOverlay',resetPom));
      document.getElementById('pomStartBtn').addEventListener('click', () => {
        if (!pomRunning) { pomRunning=true; document.getElementById('pomStartBtn').textContent='Running'; startWork(); }
      });
      // Overlay click handled inline via onclick attribute referencing resetPom cleanup

      // ——— ANALYTICS ———
      let weeklyChart, monthlyChart, yearChart;
      let wOffset=0, mOffset=0, yOffset=0;
      function renderAnalytics() {
        const ref = parseDate(today);
        // Weekly
        const baseWeek = addDays(ref, wOffset*7);
        const sun = addDays(baseWeek, -baseWeek.getDay());
        const wLabels=[], wData=[];
        for (let i=0; i<7; i++) { const d=addDays(sun,i); wLabels.push(`${weekdays[d.getDay()]} ${d.getMonth()+1}/${d.getDate()}`); wData.push(state.taskLog[formatDate(d)]||0); }
        document.getElementById('weeklyLabel').textContent = `Week of ${sun.getMonth()+1}/${sun.getDate()}`;
        // Monthly
        const baseMon = new Date(ref.getFullYear(), ref.getMonth()+mOffset, 1);
        const dim = new Date(baseMon.getFullYear(), baseMon.getMonth()+1, 0).getDate();
        const mLabels=[], mData=[];
        for (let d=1; d<=dim; d++) { mLabels.push(String(d)); mData.push(state.taskLog[formatDate(new Date(baseMon.getFullYear(), baseMon.getMonth(), d))]||0); }
        document.getElementById('monthlyLabel').textContent = baseMon.toLocaleDateString(undefined, { month:'long', year:'numeric' });
        // Yearly
        const baseYear = new Date(ref.getFullYear()+yOffset, 0, 1);
        const yLabels=[], yData=[];
        for (let mm=0; mm<12; mm++) {
          yLabels.push(new Date(baseYear.getFullYear(), mm, 1).toLocaleDateString(undefined, { month:'short' }));
          yData.push(Object.entries(state.taskLog).reduce((sum,[k,v])=>{
            const dt=parseDate(k);
            return dt.getFullYear()===baseYear.getFullYear() && dt.getMonth()===mm ? sum+v : sum;
          },0));
        }
        document.getElementById('yearLabel').textContent = baseYear.getFullYear();
        // Charts
        function updateChart(chart, ctx, labels, data) {
          if (chart) { chart.data.labels=labels; chart.data.datasets[0].data=data; chart.update(); }
          else { return new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Tasks Completed', data, backgroundColor:'orange' }] }, options:{ responsive:true, scales:{ y:{ beginAtZero:true, precision:0 } } } }); }
        }
        weeklyChart  = updateChart(weeklyChart,  document.getElementById('weeklyChart').getContext('2d'),  wLabels, wData);
        monthlyChart = updateChart(monthlyChart, document.getElementById('monthlyChart').getContext('2d'), mLabels, mData);
        yearChart    = updateChart(yearChart,    document.getElementById('yearChart').getContext('2d'),    yLabels, yData);
      }
      ['week-prev','week-next'].forEach(id => document.getElementById(id).addEventListener('click', () => { wOffset += id==='week-next'?1:-1; renderAnalytics(); }));
      ['month-prev','month-next'].forEach(id => document.getElementById(id).addEventListener('click', () => { mOffset += id==='month-next'?1:-1; renderAnalytics(); }));
      ['year-prev','year-next'].forEach(id => document.getElementById(id).addEventListener('click', () => { yOffset += id==='year-next'?1:-1; renderAnalytics(); }));
      document.querySelector('[data-toggle="analytics"]').addEventListener('click', () => { renderAnalytics(); toggleModal('analyticsModal','analyticsOverlay'); });

      // ——— KEY SHORTCUTS ———
      document.addEventListener('keydown', e => {
        if (e.key==='d') document.getElementById('btn-toggle-dark').click();
        if (e.key==='m') document.querySelector('[data-toggle="menu"]').click();
      });
      // Persist dark mode on load
      if (store.get('darkMode', false)) document.body.classList.add('dark');

      // Initialize
      initTitleSelectors();
      updateDisplays();
    });
  </script>
</body>
</html>
