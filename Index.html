<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Task Tracker v1.3 (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” CORE STYLES â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    body { font-family:sans-serif; text-align:center; padding:20px; background:#f0f0f0; color:#000; }
    body.dark { background:#121212; color:#e0e0e0; }
    .counter { font-size:1.2em; margin:5px }
    button { font-size:1.2em; padding:10px 20px; margin:10px; cursor:pointer; }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” CALENDAR â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    .calendar { display:grid; grid-template-columns:repeat(7,40px); gap:4px; justify-content:center; margin-top:20px; }
    .day { width:40px; height:40px; border:1px solid #999; display:flex; align-items:center; justify-content:center; font-size:0.8em; }
    .day.white{background:white;color:black} .day.red{background:red;color:white}
    .day.blue{background:blue;color:white} .day.black{background:black;color:white}
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” TITLE & BADGES â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    #title-container { display:flex; align-items:center; justify-content:center; margin-bottom:10px; }
    .title-badge { width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:1.5em; cursor:pointer; }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” SETTINGS MENU â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    #menuOverlay { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:999; }
    #settingsMenu {
      display:none; position:fixed; top:20%; left:50%; transform:translate(-50%,-20%);
      background:rgba(0,0,0,0.8); color:white; padding:30px; border-radius:10px; z-index:1000;
      text-align:center; width:80%; max-width:300px;
    }
    #settingsMenu button, #settingsMenu select {
      display:block; width:80%; margin:10px auto; font-size:1em; padding:8px;
    }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” BADGE MODAL â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    #badgeModal {
      display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
      background:#222; color:#fff; padding:20px; border-radius:10px; z-index:2000; max-width:600px; text-align:center;
    }
    #badgeGrid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
      gap:15px; justify-items:center; margin-top:20px;
    }
    #badgePopup {
      display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:#333; color:#fff; padding:15px 30px; border-radius:8px; z-index:3000;
      box-shadow:0 0 10px #000; font-weight:bold;
    }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” STREAK GLOW â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    @keyframes streakPop {0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
    .streak-boost {
      animation:streakPop 0.8s ease-in-out;
      color:orange; text-shadow:0 0 8px orange, 0 0 12px black;
    }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” POMODORO â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    #pomodoroOverlay {
      display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.5); z-index:3500;
    }
    .pom-modal {
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; color:#000; padding:20px; border-radius:8px; z-index:4000;
      box-shadow:0 0 10px rgba(0,0,0,0.5); text-align:center; width:200px;
    }
    body.dark .pom-modal { background:#333; color:#e0e0e0; }
    #pomProgressContainer {
      position:relative; width:140px; height:140px; margin:20px auto;
      border-radius:50%; background:conic-gradient(black 0%, black 100%);
    }
    #pomTimerDisplay {
      position:absolute; width:100%; height:100%; top:0; left:0;
      display:flex; align-items:center; justify-content:center; font-size:1.5em;
    }
    /*â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ANALYTICS â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”*/
    #analyticsOverlay {
      display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.5); z-index:3500;
    }
    .analytics-modal {
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:#fff; color:#000; padding:20px; border-radius:8px; z-index:4000;
      box-shadow:0 0 10px rgba(0,0,0,0.5); width:90%; max-width:600px; text-align:center;
      overflow-y:auto; max-height:90vh;
    }
    body.dark .analytics-modal { background:#333; color:#e0e0e0; }
    .analytics-modal h2 { margin-top:0; }
    .chart-nav {
      display:flex; justify-content:center; align-items:center; margin-bottom:8px;
    }
    .chart-nav button { margin:0 10px; }
    .chart-label { font-weight:bold; margin:0 8px; }
    .chart-container { width:100%; margin:20px 0; }
  </style>
</head>
<body>
  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” TITLE & BADGES â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div id="title-container">
    <div id="badgeLeft" class="title-badge"></div>
    <h1 style="margin:0 10px;">Daily Task Tracker v1.3</h1>
    <div id="badgeRight" class="title-badge"></div>
  </div>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” COUNTERS â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <p class="counter">Date: <span id="currentDate"></span></p>
  <p class="counter">Daily Tasks Left: <span id="tasksLeft"></span></p>
  <p class="counter">Daily Tasks Completed: <span id="tasksDone"></span></p>
  <p class="counter">Total Tasks Completed: <span id="totalTasksDone"></span></p>
  <p class="counter">Current Streak: <span id="streak"></span> days</p>
  <p class="counter">Longest Streak: <span id="longestStreak"></span> days</p>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” CONTROLS â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <button onclick="completeTask()">Complete Task</button>
  <button onclick="resetDay()">Reset Day</button>
  <button onclick="advanceDay(-1)">-1 Day</button>
  <button onclick="advanceDay(1)">+1 Day</button>
  <button onclick="exportTrackerData()">Save Backup</button>
  <input type="file" id="importInput" accept=".json" style="display:none" />
  <button onclick="document.getElementById('importInput').click()">Import Backup</button>
  <button onclick="toggleMenu()">Menu</button>
  <button onclick="togglePomodoro()">Pomodoro</button>
  <button onclick="toggleAnalytics()">Analytics</button>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” CALENDAR â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div class="calendar" id="calendar"></div>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” SETTINGS MENU â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div id="menuOverlay" onclick="toggleMenu(false)"></div>
  <div id="settingsMenu">
    <select id="selectLeftBadge"></select>
    <select id="selectRightBadge"></select>
    <button onclick="toggleBadgeModal()">Badges</button>
    <button onclick="resetBadges()">Reset Badges</button>
    <h2>Settings Menu</h2>
    <button onclick="resetTotalTasks()">Reset Total Tasks</button>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <button onclick="resetDay()">Reset Day</button>
    <button onclick="advanceDay(-1)">-1 Day</button>
    <button onclick="advanceDay(1)">+1 Day</button>
    <button onclick="toggleMenu(false)">Close</button>
  </div>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” BADGE MODAL â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div id="badgeModal">
    <h2>Achievements</h2>
    <div id="badgeGrid"></div>
    <button onclick="toggleBadgeModal(false)">Close</button>
  </div>
  <div id="badgePopup"></div>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” POMODORO MODAL â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div id="pomodoroOverlay" onclick="togglePomodoro(false)"></div>
  <div id="pomodoroModal" class="pom-modal">
    <h2>Pomodoro Timer</h2>
    <div id="pomProgressContainer">
      <div id="pomTimerDisplay">25:00</div>
    </div>
    <button id="pomStartBtn">Start Pomodoro</button>
    <button onclick="togglePomodoro(false)">Close</button>
  </div>

  <!-- â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ANALYTICS MODAL â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” -->
  <div id="analyticsOverlay" onclick="toggleAnalytics(false)"></div>
  <div id="analyticsModal" class="analytics-modal">
    <h2>Weekly â€¢ Monthly â€¢ Year Analytics</h2>

    <div class="chart-nav">
      <button onclick="changeWeek(-1)">&larr;</button>
      <span id="weeklyLabel" class="chart-label"></span>
      <button onclick="changeWeek(1)">&rarr;</button>
    </div>
    <div class="chart-container"><canvas id="weeklyChart"></canvas></div>

    <div class="chart-nav">
      <button onclick="changeMonth(-1)">&larr;</button>
      <span id="monthlyLabel" class="chart-label"></span>
      <button onclick="changeMonth(1)">&rarr;</button>
    </div>
    <div class="chart-container"><canvas id="monthlyChart"></canvas></div>

    <div class="chart-nav">
      <button onclick="changeYear(-1)">&larr;</button>
      <span id="yearLabel" class="chart-label"></span>
      <button onclick="changeYear(1)">&rarr;</button>
    </div>
    <div class="chart-container"><canvas id="yearChart"></canvas></div>

    <button onclick="toggleAnalytics(false)">Close</button>
  </div>

  <script>
    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 1) Supabase Init â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const SUPABASE_URL     = 'https://okpnfokqwfwvkpdnxpdj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rcG5mb2txd2Z3dmtwZG54cGRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxMDIxMDQsImV4cCI6MjA2MjY3ODEwNH0.q5ZF4E7D3KUZZ20UVhubjnT2mMYowcKFWd84LxRxMP4';
    const supabase         = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 2) CORE STATE (NO localStorage) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const defaultTasks = 3;
    let userId,
        today, tasksLeft, tasksDone, totalTasksDone,
        streak, longestStreak,
        taskLog, badges;

    const initialBadges = [
      { id:"badge_first",   name:"First Task",   description:"Complete 1 task",        unlocked:false },
      { id:"badge_five",    name:"Five Tasks",   description:"Complete 5 total tasks", unlocked:false },
      { id:"badge_streak3", name:"3-Day Streak", description:"Achieve a 3-day streak", unlocked:false }
    ];

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” HELPERS â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function parseDate(str) {
      const [y,m,d] = str.split('-').map(Number);
      return new Date(y, m-1, d);
    }
    function formatDate(dt) {
      const y=dt.getFullYear(),
            mo=String(dt.getMonth()+1).padStart(2,'0'),
            da=String(dt.getDate()).padStart(2,'0');
      return `${y}-${mo}-${da}`;
    }
    function addDays(dt,n){
      const r=new Date(dt);
      r.setDate(r.getDate()+n);
      return r;
    }
    const weekdays=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 3) LOAD OR CREATE STATE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function loadState() {
      // sign in anonymously
      const { data:{ user }, error: authErr } = await supabase.auth.signInAnonymously();
      if (authErr) return console.error('Auth error', authErr);
      userId = user.id;

      // try fetch
      let { data, error } = await supabase
        .from('tracker')
        .select('state')
        .eq('user_id', userId)
        .single();

      let s;
      if (error) {
        // create fresh
        s = {
          today: formatDate(new Date()),
          tasksLeft: defaultTasks,
          tasksDone: 0,
          totalTasksDone: 0,
          streak: 0,
          longestStreak: 0,
          taskLog: {},
          badges: initialBadges
        };
        await supabase.from('tracker').insert({ user_id: userId, state: s });
      } else {
        s = data.state;
      }

      // assign
      today           = s.today;
      tasksLeft       = s.tasksLeft;
      tasksDone       = s.tasksDone;
      totalTasksDone  = s.totalTasksDone;
      streak          = s.streak;
      longestStreak   = s.longestStreak;
      taskLog         = s.taskLog;
      badges          = s.badges;

      updateDisplays();
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 4) SAVE STATE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function saveState() {
      const payload = {
        today,
        tasksLeft,
        tasksDone,
        totalTasksDone,
        streak,
        longestStreak,
        taskLog,
        badges
      };
      const { error } = await supabase
        .from('tracker')
        .upsert({ user_id: userId, state: payload });
      if (error) console.error('Save error', error);
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 5) TASK FUNCTIONS (async + saveState) â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    async function completeTask(){
      if (tasksLeft > 0) tasksLeft--;
      tasksDone++; totalTasksDone++;
      taskLog[today] = tasksDone;

      const prevStr = streak, prevLong = longestStreak;
      updateDisplays();

      if (streak > prevStr) {
        const el = document.getElementById("streak");
        el.classList.add("streak-boost");
        setTimeout(()=>el.classList.remove("streak-boost"),800);
      }
      if (longestStreak > prevLong) {
        const elL = document.getElementById("longestStreak");
        elL.classList.add("streak-boost");
        setTimeout(()=>elL.classList.remove("streak-boost"),800);
      }
      if (tasksDone >= defaultTasks) {
        confetti({ particleCount:100, spread:60, origin:{y:0.6}, colors:['#000','#FFA500'] });
      }

      await saveState();
    }

    async function resetDay(){
      tasksDone = 0;
      tasksLeft = defaultTasks;
      delete taskLog[today];
      updateDisplays();
      await saveState();
    }

    async function resetTotalTasks(){
      totalTasksDone = 0;
      badges.forEach(b=>{
        if (b.id==="badge_first"||b.id==="badge_five") b.unlocked = false;
      });
      initializeBadges();
      updateDisplays();
      alert("Total tasks and relevant badges reset.");
      await saveState();
    }

    async function resetBadges(){
      badges.forEach(b=>b.unlocked=false);
      initializeBadges();
      await saveState();
    }

    async function advanceDay(offset){
      const d = addDays(parseDate(today), offset);
      today = formatDate(d);
      tasksDone = 0;
      tasksLeft = defaultTasks;
      updateDisplays();
      await saveState();
    }

    function exportTrackerData(){
      const data={tasksLeft,tasksDone,totalTasksDone,streak,longestStreak,taskLog,badges};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob),a=document.createElement("a");
      a.href=url; a.download=`backup-${today}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    async function importTrackerData(evt){
      const file=evt.target.files[0]; if(!file)return;
      const reader=new FileReader();
      reader.onload=async e=>{
        const data=JSON.parse(e.target.result);
        tasksLeft      = data.tasksLeft      || tasksLeft;
        tasksDone      = data.tasksDone      || tasksDone;
        totalTasksDone = data.totalTasksDone || totalTasksDone;
        streak         = data.streak         || streak;
        longestStreak  = data.longestStreak  || longestStreak;
        Object.assign(taskLog, data.taskLog);
        badges         = data.badges         || badges;
        updateDisplays();
        alert("âœ… Imported successfully");
        await saveState();
      };
      reader.readAsText(file);
    }

    function showBadgePopup(name){
      const p=document.getElementById("badgePopup");
      p.textContent=`ğŸ† Badge Unlocked: ${name}!`;
      p.style.display="block";
      setTimeout(()=>p.style.display="none",3000);
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” 6) STREAK & BADGE & UI LOGIC â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function calculateLongestStreak(){
      const doneDates=Object.keys(taskLog).filter(d=>taskLog[d]>=defaultTasks).sort();
      let maxS=0,temp=0,prev=null;
      doneDates.forEach(iso=>{
        if(prev){
          const diff=Math.round((new Date(iso)-new Date(prev))/86400000);
          temp=(diff===1?temp+1:1);
        }else temp=1;
        maxS=Math.max(maxS,temp);
        prev=iso;
      });
      return maxS;
    }

    function updateStreakFromCalendar(){
      const y=parseDate(today);
      y.setDate(y.getDate()-1);
      const prevKey=formatDate(y);
      const prevDone=(taskLog[prevKey]||0)>=defaultTasks;
      if(!prevDone) streak=0;
      const countToday=taskLog[today]||0;
      if(countToday===defaultTasks && localStorage.getItem("streakLastCounted")!==today){
        streak++;
        localStorage.setItem("streakLastCounted",today);
      }
      longestStreak=calculateLongestStreak();
      // note: streak stored in Supabase, darkMode still in localStorage
    }

    function checkBadges(){
      let updated=false;
      badges.forEach(b=>{
        if(!b.unlocked){
          if(b.id==="badge_first" && totalTasksDone>=1){
            b.unlocked=true; showBadgePopup(b.name); updated=true;
          }else if(b.id==="badge_five" && totalTasksDone>=5){
            b.unlocked=true; showBadgePopup(b.name); updated=true;
          }else if(b.id==="badge_streak3" && streak>=3){
            b.unlocked=true; showBadgePopup(b.name); updated=true;
          }
        }
      });
      if(updated) initializeBadges();
    }

    function initializeBadges(){
      const grid=document.getElementById("badgeGrid");
      grid.innerHTML="";
      badges.forEach(b=>{
        const div=document.createElement("div");
        div.style.opacity=b.unlocked?"1":"0.3";
        div.style.cursor="pointer";
        div.innerHTML=`<div style="font-size:2em;">ğŸ…</div>
                       <div style="font-size:0.8em;">${b.name}</div>`;
        div.onclick=()=>alert(b.unlocked?b.description:`Locked: ${b.description}`);
        grid.appendChild(div);
      });
    }

    function drawCalendar(){
      const cal=document.getElementById("calendar");
      cal.innerHTML="";
      const ref=parseDate(today),Y=ref.getFullYear(),M=ref.getMonth();
      const fd=new Date(Y,M,1).getDay();
      for(let i=0;i<fd;i++){ const e=document.createElement("div"); e.className="day"; e.style.visibility="hidden"; cal.appendChild(e); }
      const dim=new Date(Y,M+1,0).getDate();
      for(let d=1;d<=dim;d++){
        const key=formatDate(new Date(Y,M,d));
        const v=taskLog[key]||0;
        const box=document.createElement("div");
        box.className="day "+(v===0?"white":v===1?"red":v===2?"blue":"black");
        box.textContent=d;
        cal.appendChild(box);
      }
    }

    function updateTitleBadges(){
      const leftId=localStorage.getItem("titleBadgeLeft"),
            rightId=localStorage.getItem("titleBadgeRight"),
            map=Object.fromEntries(badges.map(b=>[b.id,b])),
            leftEl=document.getElementById("badgeLeft"),
            rightEl=document.getElementById("badgeRight");
      if(map[leftId]){ leftEl.textContent="ğŸ…"; leftEl.title=map[leftId].name; } else leftEl.textContent="";
      if(map[rightId]){ rightEl.textContent="ğŸ…"; rightEl.title=map[rightId].name; } else rightEl.textContent="";
    }

    function initTitleBadgeSelectors(){
      const selL=document.getElementById("selectLeftBadge"), selR=document.getElementById("selectRightBadge");
      badges.forEach(b=>{
        const o1=document.createElement("option"); o1.value=b.id; o1.textContent=b.name; selL.appendChild(o1);
        selR.appendChild(o1.cloneNode(true));
      });
      selL.value=localStorage.getItem("titleBadgeLeft")||badges[0].id;
      selR.value=localStorage.getItem("titleBadgeRight")||badges[1].id;
      selL.onchange=e=>{ localStorage.setItem("titleBadgeLeft",e.target.value); updateTitleBadges(); };
      selR.onchange=e=>{ localStorage.setItem("titleBadgeRight",e.target.value); updateTitleBadges(); };
    }

    function updateDisplays(){
      document.getElementById("currentDate").textContent=today;
      document.getElementById("tasksLeft").textContent=tasksLeft;
      document.getElementById("tasksDone").textContent=tasksDone;
      document.getElementById("totalTasksDone").textContent=totalTasksDone;
      updateStreakFromCalendar();
      document.getElementById("streak").textContent=streak;
      document.getElementById("longestStreak").textContent=longestStreak;
      drawCalendar();
      checkBadges();
      initializeBadges();
      updateTitleBadges();
    }

    function toggleDarkMode(){
      const d=document.body.classList.toggle("dark");
      localStorage.setItem("darkMode",d);
    }

    function toggleMenu(show=null){
      const ov=document.getElementById("menuOverlay"), sm=document.getElementById("settingsMenu");
      const isVis=sm.style.display==="block", should= show===null?!isVis:show;
      ov.style.display=should?"block":"none";
      sm.style.display=should?"block":"none";
    }

    function toggleBadgeModal(show=null){
      const m=document.getElementById("badgeModal");
      const isVis=m.style.display==="block", should= show===null?!isVis:show;
      m.style.display=should?"block":"none";
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” BROWN NOISE â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    let noiseSource;
    function startBrownNoise(){
      const buf=4096;
      noiseSource=audioCtx.createScriptProcessor(buf,1,1);
      let last=0;
      noiseSource.onaudioprocess=e=>{
        const out=e.outputBuffer.getChannelData(0);
        for(let i=0;i<buf;i++){
          const w=Math.random()*2-1;
          last=(last+0.02*w)/1.02;
          out[i]=last*3.5;
        }
      };
      noiseSource.connect(audioCtx.destination);
    }
    function stopAllNoise(){
      if(noiseSource){ noiseSource.disconnect(); if(noiseSource.stop) noiseSource.stop(); noiseSource=null; }
    }
    function playTone(duration=0.2){
      const osc=audioCtx.createOscillator();
      osc.type='sine'; osc.frequency.value=440; osc.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime+duration);
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” POMODORO â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    let pomInterval=null, pomPhase='work', pomTime=25*60, pomRunning=false;
    function updatePomTimerDisplay(){
      const m=String(Math.floor(pomTime/60)).padStart(2,'0'),
            s=String(pomTime%60).padStart(2,'0');
      document.getElementById('pomTimerDisplay').textContent=`${m}:${s}`;
    }
    function updateProgressRing(){
      const total=(pomPhase==='work'?25*60:5*60),
            pct=((total-pomTime)/total)*100;
      document.getElementById('pomProgressContainer').style.background=
        `conic-gradient(orange ${pct}%, black ${pct}% 100%)`;
    }
    function tickPom(){
      pomTime--; updatePomTimerDisplay(); updateProgressRing();
      if(pomTime<=0){
        clearInterval(pomInterval);
        if(pomPhase==='work'){
          stopAllNoise(); playTone(0.5); startBreakPhase();
        } else {
          playTone(0.5); pomRunning=false;
          document.getElementById('pomStartBtn').textContent='Start Pomodoro';
        }
      }
    }
    function startWorkPhase(){
      pomPhase='work'; pomTime=25*60; updatePomTimerDisplay(); updateProgressRing();
      playTone(0.2); startBrownNoise();
      pomInterval=setInterval(tickPom,1000);
    }
    function startBreakPhase(){
      pomPhase='break'; pomTime=5*60; updatePomTimerDisplay(); updateProgressRing();
      playTone(0.2);
      pomInterval=setInterval(tickPom,1000);
    }
    function togglePomodoro(show=null){
      const modal=document.getElementById('pomodoroModal'),
            ov=document.getElementById('pomodoroOverlay'),
            isVis=modal.style.display==='block', should= show===null?!isVis:show;
      modal.style.display=should?'block':'none';
      ov.style.display=should?'block':'none';
      if(!should&&pomRunning){
        clearInterval(pomInterval); stopAllNoise(); pomRunning=false;
        document.getElementById('pomStartBtn').textContent='Start Pomodoro';
        pomPhase='work'; pomTime=25*60; updatePomTimerDisplay(); updateProgressRing();
      }
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ANALYTICS â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    let weeklyChart, monthlyChart, yearChart;
    let weekOffset=0, monthOffset=0, yearOffset=0;
    function changeWeek(delta){ weekOffset+=delta; renderAnalytics(); }
    function changeMonth(delta){ monthOffset+=delta; renderAnalytics(); }
    function changeYear(delta){ yearOffset+=delta; renderAnalytics(); }
    function renderAnalytics(){
      const ref=parseDate(today);
      // Weekly
      const refWeek=addDays(ref,weekOffset*7), startSun=addDays(refWeek,-refWeek.getDay());
      const labels7=[], data7=[];
      for(let i=0;i<7;i++){
        const d=addDays(startSun,i);
        labels7.push(`${weekdays[d.getDay()]} ${d.getMonth()+1}/${d.getDate()}`);
        data7.push(taskLog[formatDate(d)]||0);
      }
      document.getElementById('weeklyLabel').textContent=`Week of ${startSun.getMonth()+1}/${startSun.getDate()}`;
      // Monthly
      const refMon=new Date(ref.getFullYear(),ref.getMonth()+monthOffset,1),
            Y=refMon.getFullYear(), M=refMon.getMonth(),
            dim=new Date(Y,M+1,0).getDate();
      const labelsM=[], dataM=[];
      for(let d=1;d<=dim;d++){
        labelsM.push(String(d));
        dataM.push(taskLog[formatDate(new Date(Y,M,d))]||0);
      }
      document.getElementById('monthlyLabel').textContent=refMon.toLocaleDateString(undefined,{month:'long',year:'numeric'});
      // Yearly
      const refYear=new Date(ref.getFullYear()+yearOffset,0,1);
      const labelsY=[], dataY=[];
      for(let m=0;m<12;m++){
        const d=new Date(refYear.getFullYear(),m,1),
              label=d.toLocaleDateString(undefined,{month:'short'});
        labelsY.push(label);
        let sum=0;
        Object.entries(taskLog).forEach(([k,v])=>{
          const dt=parseDate(k);
          if(dt.getFullYear()===refYear.getFullYear()&&dt.getMonth()===m) sum+=v;
        });
        dataY.push(sum);
      }
      document.getElementById('yearLabel').textContent=refYear.getFullYear();
      // Render/update charts
      const wCtx=document.getElementById('weeklyChart').getContext('2d');
      if(weeklyChart){
        weeklyChart.data.labels=labels7;
        weeklyChart.data.datasets[0].data=data7;
        weeklyChart.update();
      } else {
        weeklyChart=new Chart(wCtx,{
          type:'bar',
          data:{labels:labels7,datasets:[{label:'Tasks Completed',data:data7,backgroundColor:'orange'}]},
          options:{responsive:true,scales:{y:{beginAtZero:true,precision:0}}}
        });
      }
      const mCtx=document.getElementById('monthlyChart').getContext('2d');
      if(monthlyChart){
        monthlyChart.data.labels=labelsM;
        monthlyChart.data.datasets[0].data=dataM;
        monthlyChart.update();
      } else {
        monthlyChart=new Chart(mCtx,{
          type:'bar',
          data:{labels:labelsM,datasets:[{label:'Tasks Completed',data:dataM,backgroundColor:'orange'}]},
          options:{responsive:true,scales:{y:{beginAtZero:true,precision:0}}}
        });
      }
      const yCtx=document.getElementById('yearChart').getContext('2d');
      if(yearChart){
        yearChart.data.labels=labelsY;
        yearChart.data.datasets[0].data=dataY;
        yearChart.update();
      } else {
        yearChart=new Chart(yCtx,{
          type:'bar',
          data:{labels:labelsY,datasets:[{label:'Tasks Completed',data:dataY,backgroundColor:'orange'}]},
          options:{responsive:true,scales:{y:{beginAtZero:true,precision:0}}}
        });
      }
    }

    function toggleAnalytics(show=null){
      const modal=document.getElementById('analyticsModal'),
            ov=document.getElementById('analyticsOverlay'),
            isVis=modal.style.display==='block',
            should= show===null?!isVis:show;
      if(should) renderAnalytics();
      modal.style.display=should?'block':'none';
      ov.style.display=should?'block':'none';
    }

    //â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” INIT â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    document.getElementById('importInput').addEventListener('change',importTrackerData);
    document.getElementById('pomStartBtn').addEventListener('click',()=>{
      if(!pomRunning){ pomRunning=true; document.getElementById('pomStartBtn').textContent='Running'; startWorkPhase(); }
    });
    document.addEventListener('keydown',e=>{
      if(e.key.toLowerCase()==='d') toggleDarkMode();
      if(e.key.toLowerCase()==='m') toggleMenu();
    });
    if(localStorage.getItem('darkMode')==='true') document.body.classList.add('dark');

    initTitleBadgeSelectors();
    loadState();
  </script>
</body>
</html>
