<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Task Tracker v1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family:sans-serif; text-align:center; padding:20px; background:#f0f0f0; color:#000 }
    body.dark { background:#121212; color:#e0e0e0 }
    .counter { font-size:1.2em; margin:5px }
    button { font-size:1.2em; padding:10px 20px; margin:10px; cursor:pointer }
    .calendar { display:grid; grid-template-columns:repeat(7,40px); gap:4px; justify-content:center; margin-top:20px }
    .day { width:40px; height:40px; border:1px solid #999; display:flex; align-items:center; justify-content:center; font-size:0.8em }
    .day.white { background:white; color:black }
    .day.red   { background:red;   color:white }
    .day.blue  { background:blue;  color:white }
    .day.black { background:black; color:white }
    #menuOverlay { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:999 }
    #settingsMenu {
      display:none; position:fixed; top:20%; left:50%;
      transform:translate(-50%,-20%);
      background:rgba(0,0,0,0.8); color:white;
      padding:30px; border-radius:10px; z-index:1000; text-align:center;
    }
    #settingsMenu button { display:block; width:80%; margin:10px auto }
    #badgeModal {
      display:none; position:fixed; top:10%; left:50%;
      transform:translateX(-50%); background:#222; color:#fff;
      padding:20px; border-radius:10px; z-index:2000; max-width:600px; text-align:center;
    }
    #badgeGrid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr));
      gap:15px; justify-items:center; margin-top:20px;
    }
    #badgePopup {
      display:none; position:fixed; top:20px; left:50%;
      transform:translateX(-50%); background:#333; color:#fff;
      padding:15px 30px; border-radius:8px; z-index:3000;
      box-shadow:0 0 10px #000; font-weight:bold;
    }
  </style>
</head>
<body>
  <h1>Daily Task Tracker v1.1</h1>
  <p class="counter">Date: <span id="currentDate"></span></p>
  <p class="counter">Daily Tasks Left: <span id="tasksLeft"></span></p>
  <p class="counter">Daily Tasks Completed: <span id="tasksDone"></span></p>
  <p class="counter">Total Tasks Completed: <span id="totalTasksDone"></span></p>
  <p class="counter">Current Streak: <span id="streak"></span> days</p>
  <p class="counter">Longest Streak: <span id="longestStreak"></span> days</p>

  <button onclick="completeTask()">Complete Task</button>
  <button onclick="resetDay()">Reset Day</button>
  <button onclick="advanceDay(-1)">-1 Day</button>
  <button onclick="advanceDay(1)">+1 Day</button>
  <button onclick="exportTrackerData()">Save Backup</button>
  <input type="file" id="importInput" accept=".json" style="display:none" />
  <button onclick="document.getElementById('importInput').click()">Import Backup</button>

  <div class="calendar" id="calendar"></div>

  <div id="menuOverlay" onclick="toggleMenu(false)"></div>
  <div id="settingsMenu">
    <button onclick="toggleBadgeModal()">Badges</button>
    <button onclick="resetBadges()">Reset Badges</button>
    <h2>Settings Menu</h2>
    <button onclick="resetTotalTasks()">Reset Total Tasks</button>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <button onclick="resetDay()">Reset Day</button>
    <button onclick="advanceDay(-1)">-1 Day</button>
    <button onclick="advanceDay(1)">+1 Day</button>
    <button onclick="toggleMenu(false)">Close</button>
  </div>

  <div id="badgeModal">
    <h2>Achievements</h2>
    <div id="badgeGrid"></div>
    <button onclick="toggleBadgeModal(false)">Close</button>
  </div>
  <div id="badgePopup"></div>

  <script>
    const defaultTasks = 3;
    let now = new Date();
    let today = now.toISOString().split("T")[0];

    let tasksLeft      = parseInt(localStorage.getItem("tasksLeft")) || defaultTasks;
    let tasksDone      = parseInt(localStorage.getItem("tasksDone")) || 0;
    let totalTasksDone = parseInt(localStorage.getItem("totalTasksDone")) || 0;
    let streak         = parseInt(localStorage.getItem("streak")) || 0;
    let longestStreak  = parseInt(localStorage.getItem("longestStreak")) || 0;
    const taskLog      = JSON.parse(localStorage.getItem("taskLog") || "{}");
    let savedDate      = localStorage.getItem("taskDate");

    if (savedDate !== today) {
      tasksDone = 0;
      tasksLeft = defaultTasks;
      localStorage.setItem("tasksDone", tasksDone);
      localStorage.setItem("tasksLeft", tasksLeft);
      localStorage.setItem("taskDate", today);
    }

    let badges = JSON.parse(localStorage.getItem("badges"));
    if (!Array.isArray(badges) || badges.length !== 3) {
      badges = [
        { id: "badge_first",   name: "First Task",  description: "Complete 1 task",        unlocked:false },
        { id: "badge_five",    name: "Five Tasks",  description: "Complete 5 total tasks", unlocked:false },
        { id: "badge_streak3", name: "3-Day Streak",description: "Achieve a 3-day streak", unlocked:false }
      ];
      localStorage.setItem("badges", JSON.stringify(badges));
    }

    // ‚Äî‚Äî‚Äî Fixed streak logic ‚Äî‚Äî‚Äî
    function updateStreakFromCalendar() {
      const y = new Date(today);
      y.setDate(y.getDate() - 1);
      const yKey = y.toISOString().split("T")[0];
      const prevDone = (taskLog[yKey] || 0) >= defaultTasks;
      const todayDone = (taskLog[today] || 0) >= defaultTasks;

      // only reset if missed; otherwise carry or increment
      if (todayDone) {
        streak = prevDone ? streak+1 : 1;
      }
      // else leave streak as-is (carry over)

      if (streak > longestStreak) longestStreak = streak;

      localStorage.setItem("streak", streak);
      localStorage.setItem("longestStreak", longestStreak);
    }
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    function checkBadges() {
      let updated = false;
      badges.forEach(b => {
        if (!b.unlocked) {
          if (b.id==="badge_first"    && totalTasksDone>=1) b.unlocked=true, showBadgePopup(b.name), updated=true;
          else if (b.id==="badge_five" && totalTasksDone>=5) b.unlocked=true, showBadgePopup(b.name), updated=true;
          else if (b.id==="badge_streak3"&& streak>=3)       b.unlocked=true, showBadgePopup(b.name), updated=true;
        }
      });
      if (updated) localStorage.setItem("badges",JSON.stringify(badges));
    }

    function initializeBadges() {
      const grid = document.getElementById("badgeGrid");
      grid.innerHTML="";
      badges.forEach(b => {
        const div = document.createElement("div");
        div.style.opacity = b.unlocked? "1":"0.3";
        div.style.cursor  = "pointer";
        div.innerHTML     = `<div style='font-size:2em;'>üèÖ</div><div style='font-size:0.8em;'>${b.name}</div>`;
        div.onclick       = ()=>alert(b.unlocked? b.description: `Locked: ${b.description}`);
        grid.appendChild(div);
      });
    }

    function updateDisplays() {
      document.getElementById("currentDate").textContent     = today;
      document.getElementById("tasksLeft").textContent      = tasksLeft;
      document.getElementById("tasksDone").textContent      = tasksDone;
      document.getElementById("totalTasksDone").textContent = totalTasksDone;
      updateStreakFromCalendar();
      document.getElementById("streak").textContent         = streak;
      document.getElementById("longestStreak").textContent  = longestStreak;
      drawCalendar();
      checkBadges();
      initializeBadges();
    }

    function completeTask() {
      if (tasksLeft>0) tasksLeft--;
      tasksDone++; totalTasksDone++;
      taskLog[today] = tasksDone;
      localStorage.setItem("tasksLeft",tasksLeft);
      localStorage.setItem("tasksDone",tasksDone);
      localStorage.setItem("totalTasksDone",totalTasksDone);
      localStorage.setItem("taskLog",JSON.stringify(taskLog));
      updateDisplays();
    }

    function resetDay() {
      tasksLeft=defaultTasks; tasksDone=0;
      delete taskLog[today];
      localStorage.setItem("tasksLeft",tasksLeft);
      localStorage.setItem("tasksDone",tasksDone);
      localStorage.setItem("taskLog",JSON.stringify(taskLog));
      updateDisplays();
    }

    function resetTotalTasks() {
      totalTasksDone=0;
      localStorage.setItem("totalTasksDone",0);
      badges.forEach(b=>{ if(b.id==="badge_first"||b.id==="badge_five") b.unlocked=false; });
      localStorage.setItem("badges",JSON.stringify(badges));
      updateDisplays();
    }
    function resetBadges() {
      badges.forEach(b=>b.unlocked=false);
      localStorage.setItem("badges",JSON.stringify(badges));
      initializeBadges();
    }

    function advanceDay(offset) {
      const d=new Date(today);
      d.setDate(d.getDate()+offset);
      today=d.toISOString().split("T")[0];
      if(today!==localStorage.getItem("taskDate")) {
        tasksDone=0; tasksLeft=defaultTasks;
        localStorage.setItem("tasksDone",tasksDone);
        localStorage.setItem("tasksLeft",tasksLeft);
        localStorage.setItem("taskDate",today);
      }
      updateDisplays();
    }

    function drawCalendar() {
      const cal=document.getElementById("calendar");
      cal.innerHTML="";
      const c=new Date(today),Y=c.getFullYear(),M=c.getMonth();
      const days=new Date(Y,M+1,0).getDate();
      for(let d=1;d<=days;d++){
        const key=new Date(Y,M,d).toISOString().split("T")[0];
        const v=taskLog[key]||0;
        const box=document.createElement("div");
        box.className="day "+(v===0?"white":v===1?"red":v===2?"blue":"black");
        box.textContent=d;
        cal.appendChild(box);
      }
    }

    function exportTrackerData() {
      const data={tasksLeft,tasksDone,totalTasksDone,streak,longestStreak,taskLog,badges};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob),a=document.createElement("a");
      a.href=url; a.download=`backup-${today}.json`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function importTrackerData(evt) {
      const file=evt.target.files[0]; if(!file)return;
      const reader=new FileReader();
      reader.onload=e=>{
        const data=JSON.parse(e.target.result);
        tasksLeft=data.tasksLeft||tasksLeft;
        tasksDone=data.tasksDone||tasksDone;
        totalTasksDone=data.totalTasksDone||totalTasksDone;
        streak=data.streak||streak;
        longestStreak=data.longestStreak||longestStreak;
        Object.assign(taskLog,data.taskLog);
        badges=data.badges||badges;
        localStorage.setItem("tasksLeft",tasksLeft);
        localStorage.setItem("tasksDone",tasksDone);
        localStorage.setItem("totalTasksDone",totalTasksDone);
        localStorage.setItem("streak",streak);
        localStorage.setItem("longestStreak",longestStreak);
        localStorage.setItem("taskLog",JSON.stringify(taskLog));
        localStorage.setItem("badges",JSON.stringify(badges));
        localStorage.setItem("taskDate",today);
        updateDisplays(); alert("‚úÖ Imported successfully");
      };
      reader.readAsText(file);
    }

    function showBadgePopup(name) {
      const p=document.getElementById("badgePopup");
      p.textContent=`üèÜ Badge Unlocked: ${name}!`;
      p.style.display="block";
      setTimeout(()=>p.style.display="none",3000);
    }

    function toggleDarkMode() {
      const isDark=document.body.classList.toggle("dark");
      localStorage.setItem("darkMode",isDark);
    }
    function toggleMenu(show=true) {
      document.getElementById("menuOverlay").style.display=show?"block":"none";
      document.getElementById("settingsMenu").style.display=show?"block":"none";
    }

    document.getElementById("importInput").addEventListener("change",importTrackerData);
    document.addEventListener("keydown",e=>{
      if(e.key.toLowerCase()==="d") toggleDarkMode();
      if(e.key.toLowerCase()==="m") toggleMenu();
    });
    if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");

    updateDisplays();
  </script>
</body>
</html>
