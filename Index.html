<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Task Tracker v1.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f0f0f0;
      color: #000;
    }
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }
    .counter {
      font-size: 1.2em;
      margin: 5px;
    }
    button {
      font-size: 1.2em;
      padding: 10px 20px;
      cursor: pointer;
      margin: 10px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 40px);
      gap: 4px;
      justify-content: center;
      margin-top: 20px;
    }
    .day {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
    }
    .day.white { background-color: white; color: black; }
    .day.red   { background-color: red;   color: white; }
    .day.blue  { background-color: blue;  color: white; }
    .day.black { background-color: black; color: white; }

    /* Title badges */
    #title-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }
    .title-badge {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      cursor: pointer;
    }
    #menuOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    #settingsMenu {
      display: none;
      position: fixed;
      top: 20%; left: 50%;
      transform: translate(-50%, -20%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 30px;
      border-radius: 10px;
      z-index: 1000;
      text-align: center;
    }
    #settingsMenu button,
    #settingsMenu select {
      display: block;
      width: 80%;
      margin: 10px auto;
      font-size: 1em;
      padding: 8px;
    }

    /* Badge modal */
    #badgeModal {
      display: none;
      position: fixed; top:10%; left:50%;
      transform: translateX(-50%);
      background: #222; color: #fff;
      padding: 20px; border-radius: 10px;
      z-index: 2000; max-width: 600px; text-align: center;
    }
    #badgeGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px,1fr));
      gap: 15px; justify-items: center; margin-top: 20px;
    }
    #badgePopup {
      display: none;
      position: fixed; top:20px; left:50%;
      transform: translateX(-50%);
      background: #333; color: #fff;
      padding: 15px 30px; border-radius: 8px;
      z-index: 3000; box-shadow: 0 0 10px #000;
      font-weight: bold;
    }

    /* Glow animation */
    @keyframes streakPop {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    .streak-boost {
      animation: streakPop 0.8s ease-in-out;
      color: orange;
      text-shadow: 0 0 8px orange, 0 0 12px black;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <!-- Title with left/right badges -->
  <div id="title-container">
    <div id="badgeLeft" class="title-badge"></div>
    <h1 style="margin: 0 10px;">Daily Task Tracker v1.2</h1>
    <div id="badgeRight" class="title-badge"></div>
  </div>

  <!-- Counters -->
  <p class="counter">Date: <span id="currentDate"></span></p>
  <p class="counter">Daily Tasks Left: <span id="tasksLeft"></span></p>
  <p class="counter">Daily Tasks Completed: <span id="tasksDone"></span></p>
  <p class="counter">Total Tasks Completed: <span id="totalTasksDone"></span></p>
  <p class="counter">Current Streak: <span id="streak"></span> days</p>
  <p class="counter">Longest Streak: <span id="longestStreak"></span> days</p>

  <!-- Controls -->
  <button onclick="completeTask()">Complete Task</button>
  <button onclick="resetDay()">Reset Day</button>
  <button onclick="advanceDay(-1)">-1 Day</button>
  <button onclick="advanceDay(1)">+1 Day</button>
  <button onclick="exportTrackerData()">Save Backup</button>
  <input type="file" id="importInput" accept=".json" style="display:none" />
  <button onclick="document.getElementById('importInput').click()">Import Backup</button>

  <!-- Calendar -->
  <div class="calendar" id="calendar"></div>

  <!-- Settings menu -->
  <div id="menuOverlay" onclick="toggleMenu(false)"></div>
  <div id="settingsMenu">
    <!-- New selectors for title badges -->
    <select id="selectLeftBadge"></select>
    <select id="selectRightBadge"></select>
    <button onclick="toggleBadgeModal()">Badges</button>
    <button onclick="resetBadges()">Reset Badges</button>
    <h2>Settings Menu</h2>
    <button onclick="resetTotalTasks()">Reset Total Tasks</button>
    <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <button onclick="resetDay()">Reset Day</button>
    <button onclick="advanceDay(-1)">-1 Day</button>
    <button onclick="advanceDay(1)">+1 Day</button>
    <button onclick="toggleMenu(false)">Close</button>
  </div>

  <!-- Badge modal -->
  <div id="badgeModal">
    <h2>Achievements</h2>
    <div id="badgeGrid"></div>
    <button onclick="toggleBadgeModal(false)">Close</button>
  </div>
  <div id="badgePopup"></div>

  <script>
    const defaultTasks = 3;
    let now    = new Date();
    let today  = now.toISOString().split("T")[0];

    let tasksLeft      = parseInt(localStorage.getItem("tasksLeft")) || defaultTasks;
    let tasksDone      = parseInt(localStorage.getItem("tasksDone")) || 0;
    let totalTasksDone = parseInt(localStorage.getItem("totalTasksDone")) || 0;
    let streak         = parseInt(localStorage.getItem("streak")) || 0;
    let longestStreak  = parseInt(localStorage.getItem("longestStreak")) || 0;
    const taskLog      = JSON.parse(localStorage.getItem("taskLog") || "{}");
    let savedDate      = localStorage.getItem("taskDate");

    if (savedDate !== today) {
      tasksDone = 0;
      tasksLeft = defaultTasks;
      localStorage.setItem("tasksDone", tasksDone);
      localStorage.setItem("tasksLeft", tasksLeft);
      localStorage.setItem("taskDate", today);
    }

    // Load or init badges
    let badges = JSON.parse(localStorage.getItem("badges"));
    if (!Array.isArray(badges) || badges.length !== 3) {
      badges = [
        { id:"badge_first",   name:"First Task",   description:"Complete 1 task",        unlocked:false },
        { id:"badge_five",    name:"Five Tasks",   description:"Complete 5 total tasks", unlocked:false },
        { id:"badge_streak3", name:"3-Day Streak", description:"Achieve a 3-day streak", unlocked:false }
      ];
      localStorage.setItem("badges", JSON.stringify(badges));
    }

    // Full-history longest streak
    function calculateLongestStreak() {
      const doneDates = Object.keys(taskLog)
        .filter(d=>taskLog[d]>=defaultTasks).sort();
      let maxS=0, temp=0, prev=null;
      for (const iso of doneDates) {
        if (prev) {
          const diff = Math.round((new Date(iso)-new Date(prev))/86400000);
          temp = diff===1 ? temp+1 : 1;
        } else temp=1;
        if (temp>maxS) maxS=temp;
        prev=iso;
      }
      return maxS;
    }

    // Day-to-day streak + recalc longest
    function updateStreakFromCalendar() {
      const y = new Date(today); y.setDate(y.getDate()-1);
      const prevDone  = (taskLog[y.toISOString().split("T")[0]]||0)>=defaultTasks;
      const todayDone = (taskLog[today]||0)>=defaultTasks;
      if (!prevDone) streak=0;
      if (todayDone) streak++;
      longestStreak=calculateLongestStreak();
      localStorage.setItem("streak", streak);
      localStorage.setItem("longestStreak", longestStreak);
    }

    // Title badge updater
    function updateTitleBadges() {
      const leftId  = localStorage.getItem("titleBadgeLeft");
      const rightId = localStorage.getItem("titleBadgeRight");
      const map = Object.fromEntries(badges.map(b=>[b.id,b]));
      const leftEl  = document.getElementById("badgeLeft");
      const rightEl = document.getElementById("badgeRight");
      if (map[leftId]) leftEl.innerHTML  = "🏅", leftEl.title=map[leftId].name;
      else leftEl.innerHTML="";
      if (map[rightId]) rightEl.innerHTML= "🏅", rightEl.title=map[rightId].name;
      else rightEl.innerHTML="";
    }

    // Populate selectors
    function initTitleBadgeSelectors() {
      const selL = document.getElementById("selectLeftBadge");
      const selR = document.getElementById("selectRightBadge");
      badges.forEach(b=>{
        const o1 = document.createElement("option");
        o1.value=b.id; o1.textContent=b.name; selL.appendChild(o1);
        const o2 = o1.cloneNode(true); selR.appendChild(o2);
      });
      selL.value = localStorage.getItem("titleBadgeLeft")||"badge_first";
      selR.value = localStorage.getItem("titleBadgeRight")||"badge_five";
      selL.onchange = e=>{ localStorage.setItem("titleBadgeLeft",e.target.value); updateTitleBadges(); };
      selR.onchange = e=>{ localStorage.setItem("titleBadgeRight",e.target.value); updateTitleBadges(); };
    }

    // (existing badge, calendar, display, and control functions...)

    function checkBadges() { /* unchanged */ }
    function initializeBadges() { /* unchanged */ }
    function drawCalendar() { /* unchanged */ }

    function updateDisplays() {
      document.getElementById("currentDate").textContent     = today;
      document.getElementById("tasksLeft").textContent      = tasksLeft;
      document.getElementById("tasksDone").textContent      = tasksDone;
      document.getElementById("totalTasksDone").textContent = totalTasksDone;
      updateStreakFromCalendar();
      document.getElementById("streak").textContent         = streak;
      document.getElementById("longestStreak").textContent  = longestStreak;
      drawCalendar();
      checkBadges();
      initializeBadges();
      updateTitleBadges();
    }

    function completeTask() {
      if (tasksLeft>0) tasksLeft--;
      tasksDone++; totalTasksDone++;
      taskLog[today]=tasksDone;
      localStorage.setItem("tasksLeft",tasksLeft);
      localStorage.setItem("tasksDone",tasksDone);
      localStorage.setItem("totalTasksDone",totalTasksDone);
      localStorage.setItem("taskLog",JSON.stringify(taskLog));

      const prevS=streak, prevL=longestStreak;
      updateDisplays();

      if (streak>prevS) {
        const el=document.getElementById("streak");
        el.classList.add("streak-boost");
        setTimeout(()=>el.classList.remove("streak-boost"),800);
      }
      if (longestStreak>prevL) {
        const el=document.getElementById("longestStreak");
        el.classList.add("streak-boost");
        setTimeout(()=>el.classList.remove("streak-boost"),800);
      }

      if (tasksDone>=defaultTasks) {
        confetti({ particleCount:100, spread:60, origin:{y:0.6},
                   colors:['#000000','#FFA500'] });
      }
    }

    // resetDay, resetTotalTasks, resetBadges, advanceDay, exportTrackerData,
    // importTrackerData, showBadgePopup, toggleDarkMode, toggleMenu,
    // toggleBadgeModal remain unchanged...

    // setup
    document.getElementById("importInput").addEventListener("change",importTrackerData);
    document.addEventListener("keydown",e=>{
      if(e.key.toLowerCase()==="d") toggleDarkMode();
      if(e.key.toLowerCase()==="m") toggleMenu();
    });
    if(localStorage.getItem("darkMode")==="true") document.body.classList.add("dark");
    initTitleBadgeSelectors();
    updateDisplays();
  </script>
</body>
</html>
